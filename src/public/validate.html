<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Escáner QR</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h1>Escanea tu ticket</h1>
  <div id="reader" style="width: 400px;"></div>
  <div id="result"></div>
  <button onclick="location.reload()">Escanear otro</button>

  <script>
    const resultElem = document.getElementById('result');
    const html5QrCode = new Html5Qrcode("reader");
    const baseURL = "https://d451-89-7-6-34.ngrok-free.app/validate/";
    function onScanSuccess(qrCodeMessage) {
      console.log('✅ QR leído:', qrCodeMessage);

      // Detener escaneo después de leer 1 vez
      html5QrCode.stop().then(() => {
        console.log("⛔ Escaneo detenido");

        // Validar ticket en el backend
        fetch(`${baseURL}${qrCodeMessage}`)
          .then(res => res.json())
          .then(data => {
            resultElem.innerHTML = `<strong>${data.message}</strong>`;
          })
          .catch(err => {
            resultElem.innerHTML = `<strong>Error al validar el ticket</strong>`;
          });

      }).catch(err => {
        console.error("Error al detener la cámara", err);
      });
    }

    html5QrCode.start(
      { facingMode: "environment" }, // Cámara trasera
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      onScanSuccess
    );
  </script>
</body>
</html>
